# 01-6 PRD: 支援 EdgeX, Hyperliquid, Aster 交易所擴充

## 1. 專案概述
本需求旨在將 EdgeX, Hyperliquid, Aster 三個 Perp DEX 整合進現有的資金費率套利分析系統。
這將涉及資料庫結構變更、交易所支援檢查邏輯更新、以及資金費率獲取流程的整合。

## 2. 修改範圍
所有修改將採用新的版本號，以確保現有穩定版本的安全性。

| 模組 | 原版本 | 新版本 | 說明 |
| :--- | :--- | :--- | :--- |
| **資料庫** | `database_schema.py` | (原地修改) | 新增欄位，向下兼容 |
| **交易所檢查** | `exchange_trading_pair_v10.py` | `exchange_trading_pair_v11.py` | 新增 DEX 支援檢查與上市日期獲取 |
| **費率獲取** | `fetch_FR_history_group_v2.py` | `fetch_FR_history_group_v3.py` | 整合 `perp_dex_dev` 獲取 DEX 數據 |
| **總控** | `master_controller_v3.py` | (原地修改) | 支援新版本腳本與參數 |

---

## 3. 詳細規格

### 3.1 資料庫變更 (`database_schema.py`)
在 `trading_pair` 表中新增以下欄位：
- `edgex_support` (BOOLEAN)
- `edgex_list_date` (DATETIME)
- `hyperliquid_support` (BOOLEAN)
- `hyperliquid_list_date` (DATETIME)
- `aster_support` (BOOLEAN)
- `aster_list_date` (DATETIME)

**執行動作**：
需提供 SQL 腳本對現有 `data/funding_rate.db` 進行遷移。

### 3.2 交易所支援檢查 (`exchange_trading_pair_v11.py`)
**目標**：確認交易對是否在目標 DEX 上架，並盡可能獲取上市日期。

**實作邏輯**：
1.  **Aster**:
    -   **API**: `GET https://fapi.asterdex.com/fapi/v1/exchangeInfo`
    -   **Support**: 檢查 `symbol` 是否存在於返回列表中。
    -   **List Date**: 使用 `onboardDate` 欄位 (需轉換時間戳)。
2.  **EdgeX**:
    -   **API**: `GET https://pro.edgex.exchange/api/v1/public/meta/getMetaData`
    -   **Support**: 檢查 `contractName` (如 `BTCUSD`) 是否存在。
    -   **List Date**: Metadata 中無上市時間。
        -   *策略*: 先設為 `NULL`。若需精確日期，需額外開發「二分法搜尋最早歷史數據」的功能，但本階段先以 `NULL` 處理，代表「支援但日期未知」。
3.  **Hyperliquid**:
    -   **API**: `POST https://api.hyperliquid.xyz/info` (`{"type": "meta"}`)
    -   **Support**: 檢查 `universe` 列表中是否存在該幣種 (如 `BTC`)。注意 Hyperliquid 使用 Coin Name 而非 Pair Name，需做 `BTCUSDT` -> `BTC` 的映射。
    -   **List Date**: Metadata 中無上市時間。
        -   *策略*: 同 EdgeX，先設為 `NULL`。

**特殊處理**：
-   此程式需引入 `perp_dex_dev` 中的邏輯或直接發送 HTTP 請求，不依賴 `ccxt`。

### 3.3 資金費率獲取 (`fetch_FR_history_group_v3.py`)
**目標**：調用 `perp_dex_dev` 獲取歷史數據，並存入資料庫。

**實作邏輯**：
1.  **整合方式**：
    -   直接 import `perp_dex_dev.src.dexs` 下的 Fetcher 類別 (`EdgeXFetcher`, `HyperliquidFetcher`, `AsterFetcher`)。
    -   不透過 `subprocess` 呼叫命令行，而是直接在 Python 代碼中實例化 Fetcher 並調用 `fetch_history`，以獲得更好的控制與效能。
2.  **Settlement Only 模式**：
    -   獲取數據後，必須過濾 `is_settlement == True` 的記錄。
    -   這是為了符合使用者需求：「取得的csv裡有個欄位叫is_settlement，要挑是true的」。
3.  **Symbol 映射**：
    -   **Hyperliquid**: 輸入 `BTCUSDT` -> 傳給 Fetcher `BTC` (移除 USDT)。
    -   **EdgeX**: 輸入 `BTCUSDT` -> 傳給 Fetcher `BTC-USDT` (Fetcher 內部可能已處理，需確認)。
    -   **Aster**: 輸入 `BTCUSDT` -> 傳給 Fetcher `BTCUSDT`。
4.  **數據標準化**：
    -   將 Fetcher 返回的 `FundingRate` 物件 (timestamp 為毫秒) 轉換為系統標準格式 (timestamp 為 UTC datetime，對齊到整點)。
    -   處理 `NaN` 或缺失值。

### 3.4 總控程式 (`master_controller_v3.py`)
-   更新 `supported_exchanges` 列表，加入 `edgex`, `hyperliquid`, `aster`。
-   更新步驟配置，指向新版腳本 (`exchange_trading_pair_v11.py`, `fetch_FR_history_group_v3.py`)。

---

## 4. 開發注意事項
1.  **API 限制**：DEX 的 API Rate Limit 可能較嚴格，需在 `fetch_FR_history_group_v3.py` 中加入適當的 `sleep` 或重試機制。
2.  **路徑問題**：`perp_dex_dev` 是一個獨立的模組，需確保 Python Path 設定正確，以便在主目錄的腳本中 import。
3.  **測試**：開發完成後，需針對每個新交易所進行單獨測試，確保數據格式與現有 CEX 數據一致（特別是正負號定義、頻率等）。

