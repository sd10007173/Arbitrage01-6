# 全面測試計劃：找出系統潛在問題

## 測試目標
專門設計來找出 `strategy_ranking_v3.py`, `calculate_FR_return_list_v3.py`, 和 `master_controller_v2.py` 的問題。

## 測試環境設置
- 當前數據範圍：2025-04-15 到 2025-07-16
- 測試數據：可以刪除 2025-07-01 之後的數據進行測試
- 涉及表：funding_rate_history, funding_rate_diff, return_metrics, strategy_ranking

## 測試階段 1：數據準備和邊界測試

### 1.1 創建測試數據場景
```bash
# 備份原始數據
cp data/funding_rate.db data/funding_rate_backup.db

# 創建不同測試場景的數據
```

### 1.2 邊界條件測試場景
1. **空數據場景**: 完全刪除 2025-07-01 後的數據
2. **稀疏數據場景**: 只保留部分交易對數據
3. **單日數據場景**: 只有一天的數據
4. **缺失數據場景**: 故意創建數據缺口
5. **超大數據場景**: 測試大量交易對處理

## 測試階段 2：calculate_FR_return_list_v3.py 壓力測試

### 2.1 數據完整性測試
- [ ] **測試目標**: 找出數據依賴問題
- [ ] **測試場景**: 
  - funding_rate_diff 表為空
  - funding_rate_diff 表有數據但日期不連續
  - funding_rate_diff 表有 NULL 值
  - funding_rate_diff 表有異常值 (極大/極小值)
  - 只有單個交易對的數據

### 2.2 邊界條件測試
- [ ] **測試目標**: 找出計算邏輯問題
- [ ] **測試場景**:
  - 計算1天回報但只有1天數據
  - 計算7天回報但只有3天數據
  - 計算30天回報但只有10天數據
  - 所有funding_rate_diff都是0
  - 所有funding_rate_diff都是相同值

### 2.3 錯誤處理測試
- [ ] **測試目標**: 找出異常處理問題
- [ ] **測試場景**:
  - 數據庫連接失敗
  - 磁盤空間不足
  - 中斷執行（Ctrl+C）
  - 並發執行相同命令

## 測試階段 3：strategy_ranking_v3.py 邏輯測試

### 3.1 排名算法測試
- [ ] **測試目標**: 找出排名計算問題
- [ ] **測試場景**:
  - 所有交易對指標完全相同
  - 某些交易對指標為 NULL
  - 某些交易對指標為極端值
  - 只有1個交易對
  - 只有2個交易對
  - 所有指標都為負值

### 3.2 策略配置測試
- [ ] **測試目標**: 找出策略配置問題
- [ ] **測試場景**:
  - 使用不存在的策略名稱
  - 策略配置權重和為0
  - 策略配置包含無效指標
  - 策略配置權重為負數

### 3.3 數據一致性測試
- [ ] **測試目標**: 找出數據一致性問題
- [ ] **測試場景**:
  - return_metrics 表為空
  - return_metrics 表有數據但缺少某些指標
  - return_metrics 表與 strategy_ranking 表不同步
  - 部分交易對在 return_metrics 中缺失

## 測試階段 4：master_controller_v2.py 集成測試

### 4.1 參數傳遞測試
- [ ] **測試目標**: 找出參數傳遞問題
- [ ] **測試場景**:
  - 使用無效的 --top_n 參數
  - 使用無效的日期格式
  - 使用 --use-legacy 參數
  - 使用不存在的 --symbol 參數

### 4.2 執行順序測試
- [ ] **測試目標**: 找出步驟依賴問題
- [ ] **測試場景**:
  - 跳過某個步驟後執行
  - 重複執行相同步驟
  - 並行執行多個 master_controller
  - 執行過程中修改數據庫

### 4.3 資源管理測試
- [ ] **測試目標**: 找出資源洩漏問題
- [ ] **測試場景**:
  - 長時間運行監控內存使用
  - 頻繁啟動和停止
  - 處理大量數據時的資源使用
  - 網絡連接問題測試

## 測試階段 5：特殊場景壓力測試

### 5.1 極端數據測試
- [ ] **測試目標**: 找出數據處理極限
- [ ] **測試場景**:
  - 創建10000+個交易對
  - 創建連續365天的數據
  - 所有數據都是極端值
  - 數據包含特殊字符和SQL注入

### 5.2 並發和競爭測試
- [ ] **測試目標**: 找出並發問題
- [ ] **測試場景**:
  - 同時運行多個 calculate_FR_return_list_v3
  - 同時運行多個 strategy_ranking_v3
  - 在數據更新時運行排名計算
  - 在排名計算時運行數據更新

### 5.3 故障恢復測試
- [ ] **測試目標**: 找出故障恢復問題
- [ ] **測試場景**:
  - 執行中斷後重新啟動
  - 數據庫鎖定時的處理
  - 磁盤滿時的處理
  - 網絡中斷時的處理

## 測試階段 6：回歸測試

### 6.1 v2 vs v3 對比測試
- [ ] **測試目標**: 確保v3版本沒有回歸問題
- [ ] **測試場景**:
  - 使用相同數據對比v2和v3結果
  - 使用 --use-legacy 參數對比
  - 性能對比測試
  - 內存使用對比

### 6.2 歷史數據兼容性測試
- [ ] **測試目標**: 確保歷史數據處理正確
- [ ] **測試場景**:
  - 處理2025-04-15的早期數據
  - 處理不同數據格式的歷史數據
  - 處理數據結構變更前的數據

## 測試執行工具

### 自動化測試腳本
我們需要創建以下測試腳本：
1. `setup_test_scenarios.py` - 設置各種測試場景
2. `run_boundary_tests.py` - 執行邊界條件測試
3. `run_stress_tests.py` - 執行壓力測試
4. `validate_results.py` - 驗證測試結果
5. `cleanup_test_data.py` - 清理測試數據

### 監控和日誌
- 所有測試過程都要記錄詳細日誌
- 監控系統資源使用情況
- 記錄執行時間和性能指標
- 自動檢測和報告異常

## 成功標準

### 必須通過的測試
1. 所有邊界條件測試無崩潰
2. 數據完整性驗證100%通過
3. 性能測試在可接受範圍內
4. 錯誤處理覆蓋所有預期場景

### 問題發現目標
- 找出至少5個潛在的邊界條件問題
- 找出至少3個數據一致性問題
- 找出至少2個性能瓶頸
- 找出至少1個並發問題

## 測試報告
每個階段完成後，生成詳細的測試報告：
- 發現的問題清單
- 問題的嚴重程度評級
- 建議的修復方案
- 回歸測試建議

記住：**好的測試是找到問題的測試**，我們的目標是徹底暴露系統的薄弱環節！ 