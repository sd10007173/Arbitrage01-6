# 加密货币资金费率套利系统

**數據庫：funding_rate.db** (位於 `data/funding_rate.db`)

一个完整的加密货币资金费率套利分析和回测系统。

**最後更新日期：2025-07-18**

## 🔒 核心業務邏輯程式保護清單

> **重要提醒**：以下13個程式是核心業務邏輯相關的程式，已經過完整測試驗證。如非必要請勿修改，如需修改請先經過確認。

### 1. 🎛️ **master_controller_v3.py**
- **用途**：資金費率分析系統總控制器（V3.0版本）
- **目的**：自動化執行完整的資金費率分析流程
- **功能**：
  - 依序執行7個步驟的完整分析流程
  - 智能增量處理和數據完整性檢查
  - 可配置的Telegram圖片發送功能
  - 支持命令行和交互式兩種模式
- **V3.0特色**：
  - 新增 `--telegram_send` 參數，可自定義發送前後N名圖片（默認3名）
  - 支持設定為0完全跳過Telegram圖片發送
  - 基於V2.0的所有智能增量處理功能
  - 整合draw_return_metrics_v4.py圖表生成
- **程式邏輯**：參數解析 → 策略選擇 → 執行計劃確認 → 7步驟執行 → Telegram通知 → 結果報告

### 2. 📊 **market_cap_trading_pair.py**
- **用途**：市值數據更新和交易對管理
- **目的**：從CoinGecko API獲取市值排名前N的幣種數據
- **功能**：
  - 支持分頁獲取（每頁最多250筆）
  - 市值數據的更新和插入（Upsert模式）
  - API請求重試和延遲機制
  - 自動清空舊的市值排名數據
- **程式邏輯**：參數驗證 → 分頁API請求 → 清空舊數據 → 批量更新插入 → 結果統計

### 3. 🔄 **exchange_trading_pair_v10.py**
- **用途**：交易所交易對支持檢查（V10版本 - 重要修復版本）
- **目的**：檢查交易對在各交易所的支持狀態和上市日期
- **功能**：
  - 修正Bybit永續合約符號格式問題
  - 支持4個交易所（Binance、Bybit、OKX、Gate）
  - 智能API節省策略
  - 準確的上市日期獲取
- **V10重要修復**：
  - 修正V9版本中Bybit永續合約符號格式錯誤
  - V9使用 `XCN/USDT` (現貨格式)，V10使用 `XCN/USDT:USDT` (正確的永續合約格式)
  - 達到100%準確的Bybit永續合約檢測
- **策略特色**：
  - Bybit: 官方LaunchTime API + 正確永續合約格式
  - Binance: 第一筆OHLC邏輯（已驗證正確）
  - OKX/Gate: 智能跳過API呼叫，減少負載
- **程式邏輯**：連接交易所 → 成交量檢查 → 上市日期獲取 → 實際交易開始日期掃描 → 數據庫更新

### 4. 📈 **fetch_FR_history_group_v2.py**
- **用途**：批量獲取資金費率歷史數據（V2版本優化）
- **目的**：高效率批量獲取多個交易對的資金費率歷史
- **功能**：
  - 支持異步並發處理（並發限制為2）
  - 智能增量更新檢查
  - 完整時間軸生成並合併
  - 支持up_to_date自動日期檢測
- **V2版本改進**：
  - 並發限制從10調降到2，避免觸發API速率限制
  - 新增Python 3.12 SQLite日期時間兼容性處理
  - 增強的重試機制和錯誤處理
  - 支持3個交易所（Binance、Bybit、OKX）
- **程式邏輯**：篩選交易對 → 異步批量API請求 → 時間軸對齊 → 數據驗證 → 增量更新 → 數據庫存儲

### 5. 🧮 **calculate_FR_diff_v3.py**
- **用途**：計算資金費率差異（V3版本 - Pandas優化版本）
- **目的**：計算不同交易所間的資金費率差異
- **功能**：
  - 使用Pandas在記憶體中處理，避免SQL JOIN丟失數據
  - 創建完整時間軸，確保每小時都有記錄
  - 智能增量與回填處理
  - 正確的NULL值處理邏輯
- **V3主要改進**：
  - 解決V2版本的INNER JOIN問題，實現完整的時間軸覆蓋
  - 實現智能增量與回填：自動檢測缺失範圍並補充
  - 正確處理NULL值：有數據-null=有數據，null-有數據=-有數據，null-null=null
  - 支持靈活的交易所組合配置
- **程式邏輯**：智能增量檢測 → 獲取歷史數據 → Pandas透視表重塑 → 完整時間軸創建 → 差異計算 → 自定義數據庫插入

### 6. 💰 **calculate_FR_return_list_v3.py**
- **用途**：計算資金費率收益指標（V3版本 - 數據完整性檢查版本）
- **目的**：計算各交易對的資金費率收益指標
- **功能**：
  - 多時間週期收益計算（1d, 2d, 7d, 14d, 30d, all）
  - ROI指標計算
  - 數據完整性檢查和智能增量處理
  - 錯誤隔離和部分成功保存
- **V3主要改進**：
  - 數據完整性檢查：檢查每個日期的交易對數量是否完整
  - 智能增量處理：只處理缺失的交易對，避免重複計算
  - 錯誤隔離：單個交易對失敗不影響其他交易對處理
  - 部分成功保存：成功的結果立即保存，失敗的記錄到日誌
- **程式邏輯**：依賴檢查 → 數據完整性分析 → 缺失範圍計算 → SQL優化批量計算 → 增量保存 → 錯誤追蹤

### 7. 🏆 **strategy_ranking_v3.py**
- **用途**：策略排名系統（V3版本 - 數據完整性檢查版本）
- **目的**：基於多種策略對交易對進行排名
- **功能**：
  - 多策略排名計算
  - return_metrics依賴檢查
  - 策略數據完整性檢查
  - 智能增量處理
- **V3主要改進**：
  - return_metrics依賴檢查：確保依賴數據完整才執行
  - 策略數據完整性檢查：檢查每個策略的排名數據是否完整
  - 智能增量處理：只處理缺失的交易對排名，避免重複計算
  - 錯誤隔離：單個交易對排名失敗不影響其他交易對處理
- **程式邏輯**：依賴檢查 → 策略選擇 → 數據完整性分析 → 排名引擎計算 → 增量保存 → 結果驗證

### 8. 📊 **backtest_v5.py**
- **用途**：資金費率套利回測系統（V5版本）
- **目的**：基於策略排名進行歷史回測驗證
- **功能**：
  - 支持多種進場模式（固定金額、比例模式）
  - 詳細的績效指標計算
  - 互動式策略選擇
  - 批量執行模式支持
- **V5版本改進**：
  - 新增進場模式選擇：`fixed_amount`（固定金額）或`percentage_based`（比例模式）
  - 合併手續費記錄，避免重複記錄
  - 增加夏普比率計算
  - 支持批量執行模式（用於超參數調優）
- **程式邏輯**：載入策略排名 → 回測參數設定 → 模擬交易執行 → 資金費率收益計算 → 績效指標統計 → 結果保存和報告

### 9. ⚙️ **ranking_config.py**
- **用途**：排名策略配置文件
- **目的**：定義各種排名策略的參數和邏輯
- **功能**：
  - 主要策略配置（original, momentum_focused, stability_focused, balanced等）
  - 實驗性策略配置（test_simple_1d, test_simple_avg等）
  - 靈活的指標組合和權重設定
  - 支持Z-score標準化和波動率懲罰
- **程式邏輯**：基礎指標定義 → 主要策略配置 → 實驗性策略配置 → 組件權重分配

### 10. 🔧 **ranking_engine.py**
- **用途**：排名計算引擎
- **目的**：執行具體的排名計算邏輯
- **功能**：
  - 組件分數計算和標準化處理
  - 加權組合和最終排名生成
  - 支持波動率懲罰和調試功能
  - 動態策略執行
- **程式邏輯**：策略配置載入 → 組件分數計算 → 標準化處理 → 加權組合 → 最終排名生成 → 調試輸出

### 11. 📈 **draw_return_metrics_v4.py**
- **用途**：收益指標視覺化（V4版本 - 時間標記版本）
- **目的**：生成交易對收益圖表和視覺化報告
- **功能**：
  - 雙子圖生成（累積收益圖 + 每日收益圖）
  - 統計資訊框顯示（Total Return、ROI等）
  - 時間起訖標記顯示
  - 批量圖表生成
- **V4版本改進**：
  - 在圖表標題中添加時間起訖標記（YYYY-MM-DD to YYYY-MM-DD）
  - 改進統計資訊框，新增ROI顯示
  - X軸每個月都標記（V2版本改進）
- **程式邏輯**：數據讀取 → 累積收益計算 → 雙子圖創建 → 統計資訊添加 → 時間標記生成 → 圖表保存

### 12. 🗄️ **database_operations.py**
- **用途**：數據庫操作核心模組
- **目的**：提供統一的數據庫操作接口
- **功能**：
  - 完整的CRUD操作封裝
  - 批量操作和向量化處理
  - 複雜查詢和數據分析方法
  - 事務處理和錯誤處理
- **程式邏輯**：數據庫連接管理 → CRUD操作封裝 → 批量處理優化 → 複雜查詢支持 → 錯誤處理

### 13. 🏗️ **database_schema.py**
- **用途**：數據庫結構定義
- **目的**：定義和管理數據庫表結構
- **功能**：
  - 完整的表結構定義（8個主要表）
  - 索引和視圖設計
  - 外鍵約束和數據完整性檢查
  - 數據庫初始化和遷移
- **主要表結構**：
  - trading_pair：交易對基礎信息
  - funding_rate_history：資金費率歷史數據
  - funding_rate_diff：資金費率差異
  - return_metrics：收益指標
  - strategy_ranking：策略排名
  - backtest_results：回測結果
  - backtest_trades：回測交易詳情
  - market_caps：市值數據
- **程式邏輯**：表結構定義 → 索引創建 → 視圖定義 → 約束設定 → 初始化腳本

## 🚀 主要功能

### 核心工作流程（V3.0）
1. **數據獲取階段**：
   - `master_controller_v3` → 總控制器（V3.0可配置Telegram）
   - `market_cap_trading_pair` → 市值數據更新
   - `exchange_trading_pair_v10` → 交易所支持檢查（V10修復Bybit格式）
   - `fetch_FR_history_group_v2` → 批量獲取資金費率歷史（V2優化併發）

2. **數據處理階段**：
   - `calculate_FR_diff_v3` → 計算費率差異（V3 Pandas優化）
   - `calculate_FR_return_list_v3` → 計算收益指標（V3數據完整性檢查）

3. **策略分析階段**：
   - `ranking_config` + `ranking_engine` → 策略配置和計算引擎
   - `strategy_ranking_v3` → 生成策略排名（V3數據完整性檢查）

4. **回測驗證階段**：
   - `backtest_v5` → 歷史回測驗證（V5多種進場模式）

5. **結果展示階段**：
   - `draw_return_metrics_v4` → 視覺化報告（V4時間標記）

### 數據管理
- `database_schema` → 數據庫結構管理（8個主要表）
- `database_operations` → 數據庫操作接口（完整CRUD）

## 📋 系統特色

### 版本化管理
- **V3.0特色**：數據完整性檢查和智能增量處理
- **V4.0特色**：時間標記和改進的視覺化
- **V5.0特色**：多種進場模式和批量執行
- **V10特色**：修復關鍵的Bybit格式問題

### 技術優勢
- **高性能處理**：異步並發、Pandas優化、SQL優化
- **智能增量**：自動檢測缺失數據並補充
- **錯誤隔離**：單個失敗不影響整體流程
- **完整追蹤**：從原始數據到最終結果的完整記錄
- **靈活配置**：支援多種策略和參數配置

### 數據完整性保障
- **依賴檢查**：確保上游數據完整才執行下游處理
- **空洞檢測**：自動識別和回填中間缺失的數據
- **部分成功保存**：成功的結果立即保存，失敗的記錄到日誌
- **數據一致性**：完整的時間軸覆蓋和NULL值處理

## 🎯 使用範例

### 完整系統執行（V3.0）
```bash
# 使用總控制器執行完整流程
python master_controller_v3.py \
  --exchanges binance bybit \
  --top_n 100 \
  --start_date 2025-07-01 \
  --end_date 2025-07-17 \
  --strategy original \
  --yes \
  --telegram_send 5

# 自動日期檢測模式
python master_controller_v3.py \
  --exchanges binance bybit \
  --top_n 100 \
  --start_date up_to_date \
  --end_date up_to_date \
  --strategy all \
  --yes \
  --telegram_send 3
```

### 個別模組執行
```bash
# 1. 市值數據更新
python market_cap_trading_pair.py --top_n 100

# 2. 交易所支持檢查（V10版本）
python exchange_trading_pair_v10.py --exchanges binance bybit --top_n 100

# 3. 資金費率獲取（V2版本）
python fetch_FR_history_group_v2.py \
  --exchanges binance bybit \
  --top_n 100 \
  --start_date 2025-07-01 \
  --end_date 2025-07-17

# 4. 差異計算（V3版本）
python calculate_FR_diff_v3.py \
  --start-date 2025-07-01 \
  --end-date 2025-07-17

# 5. 收益計算（V3版本）
python calculate_FR_return_list_v3.py \
  --start-date 2025-07-01 \
  --end-date 2025-07-17

# 6. 策略排名（V3版本）
python strategy_ranking_v3.py \
  --start_date 2025-07-01 \
  --end_date 2025-07-17 \
  --strategies original

# 7. 回測執行（V5版本）
python backtest_v5.py

# 8. 圖表生成（V4版本）
python draw_return_metrics_v4.py --output-dir data/picture
```

## ⚠️ 重要提醒

**核心程式保護**：上述13個核心業務邏輯程式已經過完整測試驗證，如非必要請勿修改。如需修改請先確認，以確保系統穩定性。

**版本兼容性**：
- V3版本程式支援數據完整性檢查和智能增量處理
- V10版本修復了關鍵的Bybit格式問題
- V4和V5版本提供了改進的視覺化和回測功能

**更新記錄**：
- 2025-07-18：更新至V3.0架構，整合最新版本程式
- 2025-06-22：完成核心程式測試驗證，建立保護清單

## 🔧 系統架構

### 數據流向
```
CoinGecko API → trading_pair (市值數據)
         ↓
交易所API → funding_rate_history (資金費率原始數據)
         ↓  
Pandas處理 → funding_rate_diff (交易所差異)
         ↓
SQL優化 → return_metrics (收益指標)
         ↓
策略引擎 → strategy_ranking (策略排名)
         ↓
回測引擎 → backtest_results/trades (回測結果)
         ↓
視覺化 → PNG圖表 (收益圖表)
```

### 技術棧
- **語言**：Python 3.7+
- **數據庫**：SQLite 3
- **主要依賴**：pandas, numpy, matplotlib, aiohttp, ccxt
- **API**：CoinGecko, 交易所REST API
- **並發**：asyncio, aiohttp
- **通知**：Telegram Bot API

通過這個完整的架構，系統能夠提供從數據獲取到策略回測的端到端解決方案。