🎛️  資金費率分析系統總控程式 V2.1
==================================================
🖥️  命令行模式
📅 自動設定開始日期: 2025-07-14 (來自funding_rate_history最新記錄)
📅 自動設定結束日期: 2025-07-15 (UTC+0昨天)

============================================================
📋 執行計劃確認
============================================================
🏛️  交易所: binance, bybit
📊 市值排名: 前750名
📅 日期範圍: 2025-07-14 至 2025-07-15
🎯 策略: original - 原始策略

📝 執行步驟:
   1. 市值數據更新
      └─ 從 CoinGecko API 獲取市值排名前N的幣種數據並更新資料庫
   2. 交易所支持檢查
      └─ 檢查交易對在各交易所的支持狀態和上市日期
   3. 資金費率獲取
      └─ 獲取指定時間範圍內的資金費率歷史數據
   4. 差異計算
      └─ 計算交易所間的資金費率差異
   5. 收益計算
      └─ 計算資金費率收益指標
   6. 策略排名
      └─ 基於選定策略進行交易對排名
   7. 收益圖表生成
      └─ 生成交易對收益圖表（累積收益圖和每日收益圖）
============================================================

✅ 自動確認執行（--yes 參數）
✅ Telegram通知已發送

🚀 開始執行完整的資金費率分析流程
============================================================

🔄 執行步驟 1/7: 市值數據更新
   📝 從 CoinGecko API 獲取市值排名前N的幣種數據並更新資料庫
   📄 腳本: market_cap_trading_pair.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 market_cap_trading_pair.py --top_n 750
   ✅ 完成! 耗時: 4.97秒
   📤 輸出: 250 筆數據。目前總數: 500
正在請求第 3/3 頁，獲取 250 筆數據...
✅ 成功獲取 250 筆數據。目前總數: 750
正在清空舊的市值排名數據...
✅ 756 筆記錄的市值數據已被清空。
開始處理 750 筆幣種數據...

----- 更新完成 -----
總共處理了 750 筆從 API 獲取的數據。
✅ 成功更新/插入: 750 筆
❌ 失敗: 0 筆
腳本執行完畢。


🔄 執行步驟 2/7: 交易所支持檢查
   📝 檢查交易對在各交易所的支持狀態和上市日期
   📄 腳本: exchange_trading_pair_v10.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 exchange_trading_pair_v10.py --exchanges binance bybit --top_n 750
   ✅ 完成! 耗時: 293.17秒
   📤 輸出: ybit永續合約符號格式錯誤
   ✅ bybit: XCN/USDT:USDT (正確永續合約格式)
   ✅ binance: 保持現有邏輯 (已驗證正確)
   ✅ okx/gate: 智慧跳過 API 呼叫 (效率提升)
   ✅ 100%準確的Bybit永續合約檢測
============================================================


🔄 執行步驟 3/7: 資金費率獲取
   📝 獲取指定時間範圍內的資金費率歷史數據
   📄 腳本: fetch_FR_history_group_v2.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 fetch_FR_history_group_v2.py --exchanges binance bybit --top_n 750 --start_date 2025-07-14 --end_date 2025-07-15
   ✅ 完成! 耗時: 195.80秒
   📤 輸出: 2025-07-15 00:00:00 的數據...
✅ (BYBIT) HMSTR: 成功處理 48 筆數據 (含NULL)。
🚀 (BYBIT) 開始獲取 TUT 從 2025-07-15 00:00:00 的數據...
✅ (BINANCE) TUT: 成功處理 24 筆數據 (含NULL)。
✅ (BYBIT) TUT: 成功處理 24 筆數據 (含NULL)。

🎉 所有任務執行完畢！


🔄 執行步驟 4/7: 差異計算
   📝 計算交易所間的資金費率差異
   📄 腳本: calculate_FR_diff_v3.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 calculate_FR_diff_v3.py --start-date 2025-07-14 --end-date 2025-07-15 --exchanges binance bybit
   ✅ 完成! 耗時: 7.30秒
   📤 輸出: 18:23 - ============================================================
2025-07-16 00:18:23 - 🎉 V3版本處理完成！總共處理 13968 條記錄
2025-07-16 00:18:23 - ============================================================


🔄 執行步驟 5/7: 收益計算
   📝 計算資金費率收益指標
   📄 腳本: calculate_FR_return_list_v2.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 calculate_FR_return_list_v2.py --start-date 2025-07-14 --end-date 2025-07-15
   ✅ 完成! 耗時: 0.92秒
   📤 輸出:  天
   🔗 交易對: 291 個
💾 SQL優化保存: 291 條收益記錄...
📊 數據範例: Trading_Pair=1INCH_binance_bybit, Date=2025-07-15
✅ 插入收益指標數據: 291 條
✅ SQL優化保存成功: 291 條記錄
✅ 所有日期的收益指標已保存到數據庫 (291 筆記錄)
📊 處理統計: 1 天, 291 個交易對

🎉 處理完成!


🔄 執行步驟 6/7: 策略排名
   📝 基於選定策略進行交易對排名
   📄 腳本: strategy_ranking_v2.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 strategy_ranking_v2.py --start_date 2025-07-14 --end_date 2025-07-15 --strategies original
   ✅ 完成! 耗時: 0.85秒
   📤 輸出: 025-07-14 到 2025-07-15 的舊排名...
   - 成功刪除 288 條舊記錄。
   - 準備插入 579 條新記錄...
✅ 成功為策略 'original' 插入 579 條排名記錄。
✅ 數據庫插入成功: 579 條記錄
--------------------------------------------------

🎉 所有策略計算完成！總耗時: 0.06 秒


🔄 執行步驟 7/7: 收益圖表生成
   📝 生成交易對收益圖表（累積收益圖和每日收益圖）
   📄 腳本: draw_return_metrics_v3.py
   🔧 執行命令: /Users/waynechen/Downloads/Arbitrage01-3/venv/bin/python3 draw_return_metrics_v3.py --output-dir data/picture
   ✅ 完成! 耗時: 213.07秒
   📤 輸出: eturn_pic.png
   📈 總收益: 0.00
   💰 ROI: 0.00
   📊 數據點: 2 天
   📅 時間範圍: 2025-07-14 到 2025-07-15

============================================================
🎉 處理完成！
✅ 成功生成: 291 個圖表
📁 輸出目錄: data/picture

✅ Telegram通知已發送

============================================================
🎉 流程完成!
⏱️  總耗時: 716.08秒 (11.9分鐘)
============================================================

🎊 資金費率分析完成！
💡 你可以使用 view_database_simple.py 查看結果
📊 收益圖表已保存到 data/picture/ 目錄
